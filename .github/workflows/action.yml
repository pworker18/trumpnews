name: üçä Trump-News

on:
  repository_dispatch:
    types: [trump_news_bot]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  handle-users-commands:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          persist-credentials: true

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Check 5 latest news
        env:
          SITE_URL:          ${{ vars.SITE_URL }}
          DISCORD_WEBHOOK_URL_1:          ${{ vars.DISCORD_WEBHOOK_URL_1 }}
          DISCORD_WEBHOOK_URL_2: ${{ vars.DISCORD_WEBHOOK_URL_2 }}
          DISCORD_WEBHOOK_URL_3:       ${{ vars.DISCORD_WEBHOOK_URL_3 }}
          GEMINI_API_KEY_1:         ${{ vars.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2:         ${{ vars.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3:         ${{ vars.GEMINI_API_KEY_3 }}
          GEMINI_API_KEY_4:         ${{ vars.GEMINI_API_KEY_4 }}
          GEMINI_MODEL:         ${{ vars.GEMINI_MODEL }}
          TRANSLATE_TO:      ${{ vars.TRANSLATE_TO }}
          GEMINI_BATCH_SIZE: ${{ vars.GEMINI_BATCH_SIZE }}
          GEMINI_MIN_DELAY_MS:       ${{ vars.GEMINI_MIN_DELAY_MS }}
          MAX_NEWS_MESSAGES:       ${{ vars.MAX_NEWS_MESSAGES }}
          DISCORD_TAG:       ${{ vars.DISCORD_TAG }}
          LOG_FILE:       ${{ vars.LOG_FILE }}
          HEADLESS:       ${{ vars.HEADLESS }}

          
        run: npm start

      
      # Commit & push only if there are changes
      - name: Commit updated state
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
          # stash local changes before pulling
          git stash --include-untracked || true
          git pull --rebase origin main
          git stash pop || true
      
          git add logs/*.json
          git diff --cached --quiet || git commit -m "ci: update state"
          git push
